




<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">

  <title>Javascript callback</title>
  
  

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://cattail.me/tech/2013/06/19/javascript-callback.html">

  <!-- Fonts -->
  <link href='//fonts.lug.ustc.edu.cn/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
  <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:900,300' rel='stylesheet' type='text/css'>

  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41494270-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <div class="site-wrap">
      <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">猫尾博客</a>

    <nav class="site-nav">
        <a class="page-link" href="/lab">Lab</a>
        <a class="page-link" href="/feed.xml">RSS</a>
        <a class="page-link" href="/about">About</a>
    </nav>

  </div>

</header>


      <div class="body">
        <div class="wrapper">
          <div class="post yue">

            <header class="post-header">
              <h1 class="post-title">Javascript callback</h1>
              <span class="post-meta">
                Jun 19, 2013
              </span><br />
              <span class="post-meta small">
                1 minute read
              </span>
            </header>

            <article class="post-content">
              <p>阅读本文你至少应该了解异步调用的基本概念.</p>

<p>由于javascript单线程(exclude webworkers)的情况, 对于诸如网络请求等延时操作, 采用了事件和异步的方式解决阻塞的发生.</p>

<p>对于阻塞式的代码执行, 如</p>

<pre><code class="language-javascript">var data = fetchData();
calculate(data);
</code></pre>

<p>对于异步调用的代码</p>

<pre><code class="language-javascript">fetchData(function (data) {
  calculate(data);
});
</code></pre>

<p>然而, 对于大量的异步操作, 会产生嵌套的异步调用</p>

<pre><code class="language-javascript">fetchData1(function (data1) {
  fetchData2(function (data2) {
    fetchData3(function (data3) {
      calculate(data1, data2, data3);
    });
  });
});
</code></pre>

<p>大量异步调用产生的挑战包括</p>

<ul>
  <li>代码可读性: 代码中参杂了异步程序结构和正常的阻塞式程序结构</li>
  <li>程序逻辑结构: 如何进行异步的循环, 如何控制异步代码的执行顺序, 如何将大量异步代码执行结果提供给一个终止函数</li>
</ul>

<p>下面围绕这两个问题, 讲述async库提供的功能, jquery提供的deferred, 以及在语言层面寻求改进的elm.</p>

<h2 id="async">async</h2>
<p>async库主要提供了两类工具函数</p>

<ul>
  <li>单个异步调用对于数组的遍历操作</li>
  <li>大量异步调用的执行顺序</li>
</ul>

<p>async很好解决了正常程序逻辑结构面临异步调用时产生关于返回值和调用时机的问题.</p>

<p>然而, 它仍存在代码可读性上面的问题.</p>

<h2 id="jquery-defer">jquery defer</h2>
<p>jquery deferred通过链式调用(function chain)和deferred object来完成本质上异步调用<br />
的’同步’假象, 比如下面的异步函数</p>

<pre><code class="language-javascript">function createItem(item, successCallback, errorCallback) {
  $.post("/api/item", item, successCallback, errorCallback);
}
</code></pre>

<p>将被改造为</p>

<pre><code class="language-javascript">function createItem(item, successCallback, errorCallback) {
  var req = $.post("/api/item", item);
  req.success(successCallback);
  req.error(errorCallback);
}
</code></pre>

<p>极像一个同步调用.</p>

<p>而$.post实现机制类似于</p>

<pre><code class="language-javascript">function doIt() {
  var dfd = $.Deferred();

  setTimeout(function() {
    dfd.resolve('hello world');
  }, 5000);

  return dfd.promise();
}
</code></pre>

<p>事实上, async和deferred都使用了相同的方式来控制异步调用的执行—回调.</p>

<p>然而, 却使用了不同的理念来解决问题, async更像是提供了一套解决具体问题的工具箱,<br />
而jquery仅提供了deferred object, 倾向于使用阻塞式代码的方式来表现异步代码,<br />
你可以使用deferred对象来解决某个具体的问题.</p>

<h2 id="elm">elm</h2>
<p>这里引用&lt;黑客与画家&gt;中的一段话</p>

<blockquote>
  <p>如果你想解决一个困难的问题，关键不是你使用的语言是否强大,而是好几个因素同时发挥作用</p>

  <ol>
    <li>使用一种强大的语言,</li>
    <li>为这个难题写一个事实上的解释器</li>
    <li>或者, 你自己变成这个难题的人肉编译器</li>
  </ol>
</blockquote>

<p>面对异步调用的各种hack, 这句话也同样试用.</p>

<p>elm使用了所谓的Functional Reactive Programming来解决问题, 事实上, 这是一个语言层面上的signal(or event), 当时间或变量值发生变更时, 来自动调用响应函数.</p>

<h2 id="section">参考资料</h2>

<ul>
  <li><a href="https://github.com/caolan/async">async github</a></li>
  <li><a href="http://api.jquery.com/category/deferred-object/">jquery deferred object</a></li>
  <li><a href="http://ianbishop.github.io/blog/2013/01/13/escape-from-callback-hell/">escape from callback hell-the jquery way</a></li>
  <li><a href="http://elm-lang.org/learn/Escape-from-Callback-Hell.elm">Escape from Callback hell-the elm way</a></li>
</ul>

            </article>

            <a href="https://github.com/CatTail/cattail.github.io/issues/new?title=Javascript callback" style="display:block; text-align:center;">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve" fill="#888" width="60" height="60">
                    <polygon fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" points="29,24 13,24 8,28 8,24 3,24 3,6 29,6 "/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="13" x2="24" y2="13"/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="17" x2="20" y2="17"/>
                </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    
      <p class="cc">
          <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">猫尾博客</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https://cattail.me" property="cc:attributionName" rel="cc:attributionURL">Chiyu Zhong</a> 创作，<br />
          采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议</a>进行许可。
      </p>
    
    
    <p>&copy; Copyright 2013 - 2016</p>
  </div>
</footer>


    <link rel="stylesheet" href="/css/highlight/github-gist.css">
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
