




<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">

  <title>基于userID和requestID的日志实践</title>
  
  
  <meta name="description" content="介绍通过userID和requestID关联独立日志,以及在Nodejs应用中的日志实践">
  

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://cattail.me/tech/2015/09/15/logging-with-userid-and-requestid.html">

  <!-- Fonts -->
  <link href='//fonts.lug.ustc.edu.cn/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
  <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:900,300' rel='stylesheet' type='text/css'>

  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41494270-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <div class="site-wrap">
      <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">猫尾博客</a>

    <nav class="site-nav">
        <a class="page-link" href="/lab">Lab</a>
        <a class="page-link" href="/feed.xml">RSS</a>
        <a class="page-link" href="/about">About</a>
    </nav>

  </div>

</header>


      <div class="body">
        <div class="wrapper">
          <div class="post yue">

            <header class="post-header">
              <h1 class="post-title">基于userID和requestID的日志实践</h1>
              <span class="post-meta">
                Sep 15, 2015
              </span><br />
              <span class="post-meta small">
                1 minute read
              </span>
            </header>

            <article class="post-content">
              <p>本文介绍基于浏览器-服务器架构的日志处理.</p>

<h3 id="userid">userID</h3>

<p>当用户第一次访问网站时, 将被赋予一个<code>userID</code>. 这个<code>userID</code>设置在cookie中, 该用户之后的所有访问都会带上该<code>userID</code>.</p>

<pre><code>Set-Cookie: userid=ca4bac6fe62a45169723; path=/; expires=Fri, 08 Sep 2045 07:06:07 GMT; domain=.example.com; httponly
</code></pre>

<p>在记录<a href="https://en.wikipedia.org/wiki/Common_Log_Format">accesslog</a>时, 会加入userID</p>

<pre><code>::ffff:127.0.0.1 - ca4bac6fe62a45169723 [16/Sep/2015:15:05:13 +0800] "GET / HTTP/1.X" 200 72732
</code></pre>

<p>通过<code>userID</code>, 可以查询到特定用户的所有访问记录<code>accesslog</code>.</p>

<h3 id="requestid">requestID</h3>

<p>除了记录访问记录外, 在处理每个用户请求过程中, 涉及业务逻辑处理和后端服务调用等, 对某些操作也需要记录相应日志和错误.</p>

<p>对每个请求, 都生成一个唯一的<code>requestID</code>. 在这个请求的生命周期中, 所有打印的日志都会带上<code>requestID</code>信息.</p>

<pre><code>requestID=bb56f2b0-5c43-11e5-8068-adc7f452615d message=::ffff:127.0.0.1 - ca4bac6fe62a45169723 [16/Sep/2015:15:05:13 +0800] "GET / HTTP/1.X" 200 72732
</code></pre>

<p>借助<code>requestID</code>, 可以查询到特定请求的所有业务日志.</p>

<h3 id="section">其他字段</h3>

<p>那么, 怎样知道一条日志是访问日志还是业务日志呢? 如果是业务日志, 又是不是我们感兴趣的业务日志?</p>

<p>在一条完整的日志中, 还需要包含其他信息, 上面提到的就是<code>type</code>, 一条完整的日志应该包括以下内容:</p>

<ul>
  <li>version: 日志版本, 为后续日志格式修改升级留下空间</li>
  <li>app: 用于在集中式日志管理系统中区分当前日志所属的应用</li>
  <li>host: 主机名</li>
  <li>level: INFO, WARN, ERROR等</li>
  <li>timestamp: 时间戳</li>
  <li>type: 日志类型, 可选, 默认为系统日志(<code>system</code>), 还可以自己需要设置访问日志(<code>accesslog</code>)和其他自定义的类型</li>
  <li>requestID: 请求ID, 可选</li>
  <li>message: 具体日志内容, 格式由应用自己定义, 处理和解析</li>
</ul>

<pre><code>version=2 app=app-name host=zhongchiyus-MacBook-Pro.local level=INFO timestamp=1442388168 type=accesslog requestID=bb56f2b0-5c43-11e5-8068-adc7f452615d message=::ffff:127.0.0.1 - ca4bac6fe62a45169723 [16/Sep/2015:15:22:48 +0800] "POST /account/unitivelogin HTTP/1.X" 200 164
</code></pre>

<h3 id="nodejs">Node.js中的实践</h3>

<p>在Node.js中, 推荐使用<a href="https://github.com/winstonjs/winston">winston</a>打印日志, 除了丰富的功能外, 强大的<a href="https://github.com/winstonjs/winston/blob/master/docs/transports.md">transport</a>构建了一个完善的生态.</p>

<p>在Node.js应用的开发环境</p>

<ul>
  <li>实时日志打印到终端</li>
</ul>

<p>在生产环境</p>

<ul>
  <li>错误日志(WARN, ERROR级别)发送到<a href="https://getsentry.com/">sentry</a></li>
  <li>实时日志以文件形式存储在机器上, 临时存储一天</li>
  <li>延时日志发送到<a href="https://flume.apache.org/">flume</a>, 持久存储</li>
</ul>

<h2 id="section-1">参考</h2>

<ul>
  <li><a href="https://github.com/CatTail/log-starter-kit">GitHub代码示例</a></li>
  <li><a href="http://www.bitstech.net/2014/01/07/log-best-practice/">bits technology 最佳日志实践</a></li>
</ul>

            </article>

            <a href="https://github.com/CatTail/cattail.github.io/issues/new?title=基于userID和requestID的日志实践" style="display:block; text-align:center;">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve" fill="#888" width="60" height="60">
                    <polygon fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" points="29,24 13,24 8,28 8,24 3,24 3,6 29,6 "/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="13" x2="24" y2="13"/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="17" x2="20" y2="17"/>
                </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    
      <p class="cc">
          <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">猫尾博客</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https://cattail.me" property="cc:attributionName" rel="cc:attributionURL">Chiyu Zhong</a> 创作，<br />
          采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议</a>进行许可。
      </p>
    
    
    <p>&copy; Copyright 2013 - 2016</p>
    <p>本站由 <a href="https://upyun.com" target="_blank"><img src="/assets/upyun_logo_90x45.png" alt="upyun" style="width: 45px; vertical-align: bottom;"></a> 提供 CDN 存储服务</p>
    
  </div>

  <script async src="//genius.codes"></script>
</footer>


    <link rel="stylesheet" href="/css/highlight/github-gist.css">
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
