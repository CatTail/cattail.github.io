


<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">

  <title>浅谈基准测试</title>
  
  <meta name="keywords" content="nodejs,benchmark">
  
  
  <meta name="description" content="以一个实际需求出发，描述如何通过基准测试判断程序是否会对应用性能产生影响">
  

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://cattail.me/tech/2016/01/12/how-to-benchmark.html">

  <!-- Fonts -->
  <link href='//fonts.lug.ustc.edu.cn/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
  <link href='//fonts.lug.ustc.edu.cn/css?family=Lato:900,300' rel='stylesheet' type='text/css'>

  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41494270-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>


  <body>

    <div class="site-wrap">
      <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">猫尾博客</a>

    <nav class="site-nav">
        <a class="page-link" href="/lab">Lab</a>
        <a class="page-link" href="/feed.xml">RSS</a>
        <a class="page-link" href="/about">About</a>
    </nav>

  </div>

</header>


      <div class="body">
        <div class="wrapper">
          <div class="post yue">

            <header class="post-header">
              <h1 class="post-title">浅谈基准测试</h1>
              <span class="post-meta">
                Jan 12, 2016
              </span><br />
              <span class="post-meta small">
                3 minute read
              </span>
            </header>

            <article class="post-content">
              <p>在一个应用中，应前端要求需要过滤后端接口响应JSON数据中的<code>null</code>字段，过滤操作会有性能影响，那么如何决定是否增加这个功能呢？</p>

<p><strong>首先需要确定衡量指标</strong>。通常时间（time）和空间（memory）是两个衡量程序性能状况额指标，在这个例子中空间并不是制约因素，因而只考虑时间指标。</p>

<h2 id="section">实现</h2>

<p><strong>接着我们需要一个程序实现</strong>。这个实现简单的递归过滤<code>Object</code>中值为<code>null</code>的字段，</p>

<pre><code class="language-js">/**
 * 不过滤数组元素为null的情况，如
 * `[null, 'foo', null]`过滤后仍然为`[null, 'foo', null]`
 */
function prune(data) {
    if (_.isArray(data)) {
        _.each(data, prune)
    } else if (_.isObject(data)) {
        _.each(data, function(value, key) {
            if (_.isObject(value)) {
                prune(value)
            } else if (value === null) {
                delete data[key]
            }
        })
    }
    return data
}
</code></pre>

<p>单元测试见附录。</p>

<h2 id="section-1">影响因素</h2>

<p><strong>然后根据程序实现判断性能的影响因素</strong></p>

<p>什么因素会影响时间指标呢？JSON数据的大小（size）？JSON数据的字段数？JSON数据的层次结构？</p>

<p>时间指标受JSON数据的字段（包括递归字段）影响，因为在<code>prune</code>的实现中，遍历<code>Object</code>和<code>Array</code>的时间决定了程序执行时间。</p>

<h2 id="benchmark">benchmark</h2>

<p><strong>最后根据影响因素选择测试数据，进行基准测试并得出结论</strong></p>

<p>借助<a href="https://github.com/bestiejs/benchmark.js">benchmark.js</a>，以<code>noop</code>为参照组进行基准测试</p>

<p>有两组测试数据，真实线上接口获取的<code>realSamples</code>和随机生成的模拟数据<code>fakeSamples</code>。</p>

<pre><code class="language-js">var fs = require('fs')
var Benchmark = require('benchmark')
var suite = new Benchmark.Suite()
var getSample = require('./sample').getSample
var getSampleSize = require('./sample').getSampleSize
var prune = require('../src/utility').prune
var noop = function(){}

var filenames = fs.readdirSync(__dirname + '/samples')
var realSamples = filenames
    .map(function(filename) {
        return JSON.parse(
            fs.readFileSync(__dirname + `/samples/${filename}`, 'utf8')
        )
    })
var realSizes = realSamples.map(getSampleSize)

var fakeSizes = [10, 100, 1000, 10000]
var fakeSamples = fakeSizes.map(function(size) {
    return getSample(size)
})

// add tests
realSamples.forEach(function(sample, index) {
    var filename = filenames[index]
    suite
        .add(`prune#real:${filename}:${getSampleSize(sample)}`, function() {
            prune(sample)
        })
})

fakeSamples.forEach(function(sample, index) {
    var size = fakeSizes[index]
    suite
        .add(`prune#fake:${size}:${getSampleSize(sample)}`, function() {
            prune(sample)
        })
})
suite
    .add('noop', function() {
        noop(realSamples[0])
    })
// add listeners
suite
    .on('cycle', function(event) {
        console.log(String(event.target))
    })
    .on('complete', function() {
        var totalSize = realSizes.reduce(function(sum, size) {
            return sum + size
        }, 0)
        var averageSize = Math.floor(totalSize / realSizes.length)
        console.log(`real samples total size ${totalSize}, average size ${averageSize}`)
        console.log('Fastest is ' + this.filter('fastest').map('name'))
    })
// run
.run()
</code></pre>

<p>这里还实现了<code>getSampleSize</code>方法（见附录），用于统计JSON数据的字段总量。以此来粗略估计线上真实接口返回数据的平均字段数量。</p>

<p>运行结果<sup>[1]</sup></p>

<pre><code>prune#real:adverts.json:47 x 179,918 ops/sec ±2.10% (79 runs sampled)
prune#real:areas.json:5126 x 1,333 ops/sec ±2.47% (74 runs sampled)
prune#real:citys.json:6417 x 1,363 ops/sec ±1.07% (90 runs sampled)
prune#real:count.json:1037 x 6,043 ops/sec ±1.75% (89 runs sampled)
prune#real:menus.json:55 x 47,010 ops/sec ±1.34% (86 runs sampled)
prune#real:pois.json:3136 x 2,316 ops/sec ±3.16% (84 runs sampled)
prune#real:subway.json:1999 x 3,043 ops/sec ±1.85% (89 runs sampled)
prune#fake:10:10 x 286,702 ops/sec ±1.64% (88 runs sampled)
prune#fake:100:100 x 63,893 ops/sec ±1.56% (89 runs sampled)
prune#fake:1000:985 x 8,173 ops/sec ±1.63% (86 runs sampled)
prune#fake:10000:9995 x 997 ops/sec ±1.80% (87 runs sampled)
noop x 80,713,438 ops/sec ±1.85% (87 runs sampled)
real samples total size 17817, average size 2545
Fastest is noop
</code></pre>

<p><strong>结论</strong>：平均字段总量为<code>2545</code>，向上取证以<code>10000</code>量级计算，使用<code>prune</code>处理数据大约需要1ms，并不影响整个应用的性能。</p>

<h2 id="section-2">小结</h2>

<p>上面已经用黑体标记了重点，这里再做一次小结</p>

<ol>
  <li>确定衡量指标</li>
  <li>实现程序</li>
  <li>判断影响因素</li>
  <li>选择测试数据，进行基准测试</li>
  <li>得出结论</li>
</ol>

<h2 id="section-3">附录</h2>

<ol>
  <li>看起来<code>getSampleSize</code>或<code>getSample</code>函数计算有偏差，不过在这里可以忽略这个问题。</li>
</ol>

<h3 id="sample">sample生成器</h3>

<pre><code class="language-js">var Chance = require('chance')
var _ = require('lodash')

var DATA_TYPES = [
    'bool',
    'character',
    'floating',
    'integer',
    'natural',
    'string',

    'Array',
    'Object',
]

function getSample(size, sample, chance) {
    chance = chance || new Chance()
    sample = sample || {}
    var index, cursor, pick, type, key, value
    for (index=0, cursor=0; index&lt;size; index++, cursor++) {
        pick = chance.integer({min: index, max: size-1})
        switch(type = chance.pick(DATA_TYPES)) {
            case 'Array':
                value = getSample(pick - index, [], chance)
                index = pick
                break
            case 'Object':
                value = getSample(pick - index, {}, chance)
                index = pick
                break
            default:
                value = chance[type]()
        }
        key = sample.constructor.name === 'Array' ? cursor : chance.word()
        sample[key] = value
    }
    return sample
}

function getSampleSize(sample) {
    return _.reduce(sample, function(sum, value, key) {
        if (_.isArray(value)) {
            sum += getSampleSize(value)
        } else if (_.isObject(value)) {
            sum += getSampleSize(value)
        }
        return sum + 1
    }, 0)
}

module.exports = {
    getSample: getSample,
    getSampleSize: getSampleSize,
}
</code></pre>

<h3 id="section-4">单元测试</h3>

<pre><code class="language-js">describe('utility', () =&gt; {
    describe('prune', () =&gt; {
        it('do not touch primitive type', () =&gt; {
            expect(prune(123)).to.deep.equal(123)
            expect(prune('123')).to.deep.equal('123')
            expect(prune(null)).to.deep.equal(null)
            expect(prune([1, 2, '3'])).to.deep.equal([1, 2, '3'])
            expect(prune({foo: 'bar'})).to.deep.equal({foo: 'bar'})
        })

        it('prune null value in object', () =&gt; {
            expect(prune({foo: 'bar', baz: null})).to.deep.equal({foo: 'bar'})
        })

        it('do not prune null in array', () =&gt; {
            expect(
                prune([null, 'foo', null, 'bar', null])
            ).to.deep.equal([null, 'foo', null, 'bar', null])
        })

        it('complex json prune', () =&gt; {
            expect(
                prune([
                    null,
                    {
                        'foo1': 'bar1',
                        'foo2': {
                            'foo3': ['bar3', null],
                            'foo': null,
                        },
                        'foo': null
                    },
                    null
                ])
            ).to.deep.equal([
                null,
                {
                    'foo1': 'bar1',
                    'foo2': {
                        'foo3': ['bar3', null],
                    },
                },
                null
            ])
        })
    })
})
</code></pre>

            </article>

            <a href="https://github.com/CatTail/cattail.github.io/issues/new?title=浅谈基准测试" style="display:block; text-align:center;">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve" fill="#888" width="60" height="60">
                    <polygon fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" points="29,24 13,24 8,28 8,24 3,24 3,6 29,6 "/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="13" x2="24" y2="13"/>
                    <line fill="none" stroke="#888" stroke-width="2" stroke-miterlimit="10" x1="8" y1="17" x2="20" y2="17"/>
                </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    
      <p class="cc">
          <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">猫尾博客</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https://cattail.me" property="cc:attributionName" rel="cc:attributionURL">Chiyu Zhong</a> 创作，<br />
          采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议</a>进行许可。
      </p>
    
    
    <p>&copy; Copyright 2013 - 2016</p>
    <p>本站由 <a href="https://upyun.com" target="_blank"><img src="/assets/upyun_logo_90x45.png" alt="upyun" style="width: 45px; vertical-align: bottom;"></a> 提供 CDN 存储服务</p>
    
  </div>

  <script async src="//genius.codes"></script>
</footer>


    <link rel="stylesheet" href="/css/highlight/github-gist.css">
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>

</html>
